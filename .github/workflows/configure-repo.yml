name: Configure Repository Settings

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - ".github/repo-settings.json"

jobs:
  configure-repo:
    runs-on: ubuntu-latest
    permissions: write-all

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Apply Settings from JSON
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');

            const { owner, repo } = context.repo;

            const configPath = path.join(process.cwd(), '.github', 'repo-settings.json');
            console.log(`üì¶ Loading config from: ${configPath}`);

            if (!fs.existsSync(configPath)) {
              throw new Error(`Configuration file not found at ${configPath}`);
            }

            const config = JSON.parse(fs.readFileSync(configPath, 'utf8'));
            console.log(`‚úÖ Configuration loaded successfully\n`);

            // ========================================
            // CONFIGURE BRANCH PROTECTION RULES
            // ========================================
            if (config.branchProtection && false) {
              console.log('üîí Configuring Branch Protection Rules\n');
              
              for (const [branch, rules] of Object.entries(config.branchProtection)) {
                console.log(`   Protecting branch: ${branch}`);
                
                await github.rest.repos.updateBranchProtection({
                  owner,
                  repo,
                  branch,
                  ...rules
                });
                
                console.log(`   ‚úÖ ${branch} configured successfully`);
              }
              console.log('');
            } else {
              console.log('‚ö†Ô∏è No branch protection rules found in config');
            }

            // ========================================
            // CONFIGURE ENVIRONMENTS
            // ========================================
            if (config.environments && config.environments.length > 0) {
              console.log('üåç Configuring Environments\n');
              
              for (const env of config.environments) {
                console.log(`   Configuring environment: ${env.name}`);
                
                await github.rest.repos.createOrUpdateEnvironment({
                  owner,
                  repo,
                  environment_name: env.name,
                  wait_timer: env.wait_timer,
                  prevent_self_review: env.prevent_self_review,
                  reviewers: env.reviewers,
                  deployment_branch_policy: env.deployment_branch_policy
                });
                
                console.log(`   ‚úÖ ${env.name} configured successfully`);
              }
              console.log('');
            } else {
              console.log('‚ö†Ô∏è No environments found in config');
            }

            console.log('üéâ All repository settings applied successfully!');
